name: Deploy SIV to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy to Production
    runs-on: self-hosted

    # Removi o working-directory fixo para evitar erros no self-hosted runner
    # Os comandos rodar√£o na raiz do reposit√≥rio (checkout padr√£o)

    steps:
      - name: üì• Checkout reposit√≥rio
        uses: actions/checkout@v4

      - name: üßº Derrubar containers antigos
        run: |
          docker compose -f docker-compose.prod.yml down

      - name: üõ†Ô∏è Build do projeto Laravel + React
        run: |
          docker compose -f docker-compose.prod.yml build --no-cache

      - name: üöÄ Subir containers
        run: |
          docker compose -f docker-compose.prod.yml up -d

      - name: üß© Rodar comandos Laravel
        run: |
          docker compose -f docker-compose.prod.yml exec -T app.siv php artisan migrate --force
          docker compose -f docker-compose.prod.yml exec -T app.siv php artisan config:cache
          docker compose -f docker-compose.prod.yml exec -T app.siv php artisan route:cache
          docker compose -f docker-compose.prod.yml exec -T app.siv php artisan view:cache

      - name: ‚úÖ Enviar notifica√ß√£o Telegram (sucesso)
        if: success()
        run: |
          TEXT=$(cat <<EOF
            ‚úÖ *Deploy SIV finalizado com sucesso!*
            Branch: \`main\`
            Commit: [${GITHUB_SHA}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})
            Autor: ${GITHUB_ACTOR}
            Ambiente: *Produ√ß√£o*
            Data: $(date -u)
            EOF
                    )
                    curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
                        -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
                        --data-urlencode text="$TEXT" \
                        -d parse_mode=Markdown

                - name: ‚ùå Enviar notifica√ß√£o Telegram (erro)
                    if: failure()
                    run: |
                    TEXT=$(cat <<EOF
            ‚ùå *Erro no deploy do SIV!*
            Branch: \`main\`
            Commit: [${GITHUB_SHA}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})
            Autor: ${GITHUB_ACTOR}
            Ambiente: *Produ√ß√£o*
            Verifique os logs do GitHub Actions.
            EOF
                    )
                    curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
                        -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
                        --data-urlencode text="$TEXT" \
                        -d parse_mode=Markdown
